---
- name: Setup FitonDuty Dashboard Infrastructure
  hosts: dashboard_servers
  become: yes
  gather_facts: yes
  vars_files:
    - "../vars/{{ environment_name }}/vault.yml"
  vars:
    server_db_name: "{{ environment_name | default('testing') }}"
    march_db_name: "{{ db_name | default('fitonduty_march') }}"
    march_db_user: "{{ db_user | default('fitonduty_march') }}"
    database_host: "{{ db_host | default('localhost') }}"
    database_port: "{{ db_port | default('5432') }}"
    postgres_user: "{{ pg_admin_user | default('postgres') }}"
    database_url: "postgresql://{{ march_db_user }}:{{ vault_march_db_password }}@{{ database_host }}:{{ database_port }}/{{ march_db_name }}"

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

  roles:
    - march_dashboard

  post_tasks:
    - name: Wait for application to start
      wait_for:
        port: 8040
        delay: 10
        timeout: 60

    - name: Verify Connectivity
      uri:
        url: "http://localhost:8040"
        method: GET
        status_code: 200
        timeout: 5
      register: website_check
      delay: 5

    - name: Display Connectivity Result
      debug:
        msg: "Website is {{ 'accesible' if website_check.status == 200 else 'NOT accessible' }}"