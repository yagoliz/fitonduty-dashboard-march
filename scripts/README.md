# March Dashboard Seeding Scripts

This directory contains scripts to seed and manage the production database for the FitonDuty March Dashboard.

## Scripts Overview

### 1. `generate_march_seed.py`
Generates seed data configuration files with participants and auto-generated secure passwords.

**Usage:**
```bash
# Generate from CSV file
python scripts/generate_march_seed.py --csv participants.csv march_2025

# Interactive mode
python scripts/generate_march_seed.py --interactive march_2025

# With custom output path
python scripts/generate_march_seed.py --csv participants.csv march_2025 \
  --output config/seed-data/march_2025.yml

# Dry run (see what would be generated)
python scripts/generate_march_seed.py --csv participants.csv march_2025 --dry-run
```

**CSV Format:**
```csv
participant_id,group
01AB,Squad Alpha
02CD,Squad Alpha
03EF,Squad Bravo
```

**Output:** YAML configuration file with:
- Auto-generated secure passwords for all users
- Group definitions
- Participant assignments

### 2. `add_participants.py`
Adds participants from a seed YAML file to a live database. Only adds new participants, skipping existing ones.

**Usage:**
```bash
# Add participants from seed file (interactive)
python scripts/add_participants.py --seed-file config/seed-data/march_2025.yml

# With custom database URL
python scripts/add_participants.py \
  --seed-file config/seed-data/march_2025.yml \
  --db-url postgresql://user:password@host:5432/dbname

# Dry run (see what would be added)
python scripts/add_participants.py \
  --seed-file config/seed-data/march_2025.yml \
  --dry-run
```

**Features:**
- Safely adds only new participants (preserves existing data)
- Automatically creates missing groups
- Adds admin users if needed
- Uses passwords from seed file
- Confirmation prompt before making changes

### 3. `process_watch_data.py`
Processes watch export files (CSV/GPX/TCX) from Garmin, Suunto, Polar, etc. and generates CSV files for database import.

**Usage:**
```bash
# Process watch data and generate CSVs
python scripts/process_watch_data.py \
  --data-dir /path/to/watch/exports \
  --march-id 1 \
  --march-start-time 2025-03-15T08:00:00 \
  --output ./output
```

**Input files:**
- CSV files with heart rate, steps, cadence data
- GPX files with GPS tracks (optional)
- TCX files with training data (optional)

**Output files:**
- `march_health_metrics.csv` - Aggregate metrics per participant
- `march_hr_zones.csv` - Heart rate zone distributions
- `march_timeseries_data.csv` - Time-series physiological data
- `march_gps_positions.csv` - GPS tracks (if available)

**Features:**
- Handles multiple file formats (summary-only, time-series, combined)
- Merges multiple activities per participant (if watch was stopped/restarted)
- Calculates speed from GPS or cadence
- Generates HR zones and movement speed distributions

### 4. `load_march_data.py`
Loads processed watch data CSVs (generated by `process_watch_data.py`) into the database.

**Usage:**
```bash
# Load data with automatic participant mapping
python scripts/load_march_data.py \
  --data-dir ./output \
  --march-id 1

# With custom participant ID mapping
python scripts/load_march_data.py \
  --data-dir ./output \
  --march-id 1 \
  --mapping SM001:participant1,SM002:participant2,SM003:participant3

# With custom database URL
python scripts/load_march_data.py \
  --data-dir ./output \
  --march-id 1 \
  --db-url postgresql://user:password@host:5432/dbname

# Dry run (see what would be loaded)
python scripts/load_march_data.py \
  --data-dir ./output \
  --march-id 1 \
  --dry-run
```

**Features:**
- Maps participant IDs from CSV files to database user IDs
- Handles missing columns gracefully
- Updates existing data (replaces timeseries/GPS, updates metrics)
- Batch inserts for performance with large datasets
- Automatic participant registration for the march
- Confirmation prompt before making changes

**Participant ID Mapping:**
- Automatic: If CSV `user_id` matches database `username` (e.g., `participant1`)
- Custom: Use `--mapping` flag to map watch IDs to usernames (e.g., `SM001:participant1`)

### 5. `manage_march_events.py`
Creates and manages march events in the database.

**Usage:**

**Create march event (interactive):**
```bash
python scripts/manage_march_events.py create --interactive
```

**Create march event (command line):**
```bash
python scripts/manage_march_events.py create \
  --name "Training March Alpha" \
  --date 2025-03-15 \
  --distance 8.2 \
  --duration 2.5 \
  --group "Squad Alpha" \
  --route "Forest trail with moderate elevation" \
  --status planned
```

**List all march events:**
```bash
python scripts/manage_march_events.py list
```

**Update march status:**
```bash
python scripts/manage_march_events.py update-status \
  --march-id 1 \
  --status completed
```

**Add participants to a march:**
```bash
# Add all participants from march's group
python scripts/manage_march_events.py add-participants --march-id 1

# Add participants from specific group
python scripts/manage_march_events.py add-participants \
  --march-id 1 \
  --group "Squad Alpha"
```

**Available statuses:**
- `planned` - March is scheduled but not yet conducted
- `completed` - March has been completed
- `processing` - Data is being processed
- `published` - Results are published and visible to participants

## Complete Workflow

### Initial Setup

1. **Prepare participant data**
   ```bash
   # Create a CSV file with participant IDs and groups
   cat > participants.csv << EOF
   participant_id,group
   01AB,Squad Alpha
   02CD,Squad Alpha
   03EF,Squad Bravo
   EOF
   ```

2. **Generate seed configuration**
   ```bash
   python scripts/generate_march_seed.py --csv participants.csv march_2025
   ```

3. **Review and customize the generated file**
   ```bash
   # Edit config/seed-data/march_2025_seed.yml
   # Change admin password if needed
   # Verify all participants are correct
   ```

4. **Add participants to database**
   ```bash
   # Set database URL (optional)
   export DATABASE_URL="postgresql://user:password@host:5432/dbname"

   # Add participants
   python scripts/add_participants.py \
     --seed-file config/seed-data/march_2025_seed.yml
   ```

### Managing March Events

1. **Create a new march event**
   ```bash
   # Interactive mode (recommended)
   python scripts/manage_march_events.py create --interactive

   # Or via command line
   python scripts/manage_march_events.py create \
     --name "Training March Alpha" \
     --date 2025-03-15 \
     --distance 8.2 \
     --duration 2.5 \
     --group "Squad Alpha"
   ```

2. **Add participants to the march**
   ```bash
   python scripts/manage_march_events.py add-participants --march-id 1
   ```

3. **List all marches**
   ```bash
   python scripts/manage_march_events.py list
   ```

4. **Update march status after completion**
   ```bash
   python scripts/manage_march_events.py update-status \
     --march-id 1 \
     --status completed
   ```

### Loading Real March Data (Post-Event)

After a march is completed and participants hand in their watches, follow these steps to process and load the real physiological data:

1. **Collect watch export files**
   ```bash
   # Organize files in a directory structure
   mkdir -p march_data/march_alpha
   # Copy CSV, GPX, TCX files to this directory
   # Files should be named with participant identifiers (e.g., SM001.CSV, SM002.CSV)
   ```

2. **Process watch data to generate CSVs**
   ```bash
   python scripts/process_watch_data.py \
     --data-dir march_data/march_alpha \
     --march-id 1 \
     --march-start-time 2025-03-15T08:00:00 \
     --output ./output/march_alpha
   ```

3. **Load processed data into database**
   ```bash
   # If watch file IDs match database usernames (e.g., participant1.CSV)
   python scripts/load_march_data.py \
     --data-dir ./output/march_alpha \
     --march-id 1

   # If watch files use custom IDs (e.g., SM001.CSV, SM002.CSV)
   python scripts/load_march_data.py \
     --data-dir ./output/march_alpha \
     --march-id 1 \
     --mapping SM001:participant1,SM002:participant2,SM003:participant3
   ```

4. **Publish the march results**
   ```bash
   # Update march status to make results visible
   python scripts/manage_march_events.py update-status \
     --march-id 1 \
     --status published
   ```

**Notes:**
- The `process_watch_data.py` script handles various watch formats (Garmin, Suunto, Polar)
- Multiple activities per participant are automatically merged
- GPS data is optional but recommended for better speed estimation
- Use `--dry-run` flag to preview changes before loading

### Adding New Participants to Existing Campaign

1. **Update participants CSV with new entries**
   ```csv
   participant_id,group
   11UV,Squad Alpha
   12WX,Squad Bravo
   ```

2. **Generate updated seed file**
   ```bash
   python scripts/generate_march_seed.py \
     --csv new_participants.csv \
     march_2025_update
   ```

3. **Add only new participants**
   ```bash
   python scripts/add_participants.py \
     --seed-file config/seed-data/march_2025_update_seed.yml
   ```

## Environment Variables

All scripts support the following environment variables:

- `DATABASE_URL` - PostgreSQL connection URL
  ```bash
  export DATABASE_URL="postgresql://user:password@host:5432/dbname"
  ```

## Database URL Format

```
postgresql://username:password@host:port/database_name
```

**Examples:**
```bash
# Local development
postgresql://postgres:password@localhost:5432/fitonduty_march

# Production
postgresql://march_admin:SecurePass123@db.example.com:5432/fitonduty_march_prod
```

## Security Best Practices

1. **Password Management**
   - All scripts generate secure random passwords
   - Store seed files securely (never commit to version control)
   - Change default admin password immediately after setup
   - Consider using a password manager for storing credentials

2. **Database Access**
   - Use environment variables for database URLs in production
   - Create separate database users with minimal required privileges
   - Use SSL/TLS for database connections in production

3. **Seed File Storage**
   - Add `config/seed-data/*_seed.yml` to `.gitignore`
   - Store production seed files in secure vault (e.g., Ansible Vault)
   - Encrypt seed files containing production credentials

## Troubleshooting

### Connection Issues
```bash
# Test database connection
psql postgresql://user:password@host:5432/dbname -c "SELECT 1"

# Check if database exists
psql -U postgres -l
```

### Permission Errors
```bash
# Grant necessary permissions
psql -U postgres -d fitonduty_march << EOF
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO march_admin;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO march_admin;
EOF
```

### Script Errors
- Ensure all required dependencies are installed: `pip install pyyaml sqlalchemy werkzeug psycopg2-binary pandas`
- Check database schema is up to date
- Verify CSV file format matches expected structure
- For `process_watch_data.py`, additional dependencies may be needed: `pip install gpxpy`

## Example Files

See `config/seed-data/` for example files:
- `example_seed.yml` - Example seed configuration
- `example_participants.csv` - Example CSV format

## Integration with Deployment

These scripts can be integrated into deployment workflows:

```bash
# Ansible playbook example
- name: Generate seed data
  command: python scripts/generate_march_seed.py --csv /path/to/participants.csv campaign_name

- name: Add participants to database
  command: python scripts/add_participants.py --seed-file /path/to/seed.yml
  environment:
    DATABASE_URL: "{{ database_url }}"
```